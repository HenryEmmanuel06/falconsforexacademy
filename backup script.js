/* const youthVoterProfiles = [
  {
    name: "Sam",
    demographic: "White male, 34",
    voterType: "Harris voter",
    policyStances: [
      "Favors ‘Allowing gay and lesbian couples to marry legally’",
      "Thinks abortion should be ‘Legal in most cases’",
      "Thinks ‘Too many people are easily offended these days over the language that others use’"
    ],
    openEndResponse: "I did not like either candidate but Trump was a huge concern for me and my beliefs and so far during his 2nd term the worries I had about him have been correct.",
    image: "images/Sam - White Man 2.webp"
  },
  {
    name: "John",
    demographic: "White male, 30",
    voterType: "Trump voter",
    policyStances: [
      "Opposes ‘Making it more difficult to access pornography on the Internet’",
      "Favors ‘Allowing gay and lesbian couples to marry legally’",
      "Favors ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks abortion should be ‘Illegal in most cases’"
    ],
    openEndResponse: "He is not a career politician. He’s a successful businessman and the country should be ran like a business.",
    image: "images/John - White Man 3.webp"
  },
  {
    name: "Andrew",
    demographic: "White male, 38",
    voterType: "Trump voter",
    policyStances: [
      "Favors ‘Making the use of marijuana legal’",
      "Thinks abortion should be ‘Legal in most cases’",
      "Thinks ‘Too many people are easily offended these days over the language that others use’"
    ],
    openEndResponse: "I voted for Trump because I looked at both candidates and their policies, and although sometimes President Trump is a little over the top, his policy stances seem to be based more in common sense. It sounded like he wanted to secure our border and enforce the laws on the books.",
    image: "images/Andrew - White Man 1.webp"
  },
  {
    name: "Anna",
    demographic: "White female, 26",
    voterType: "Trump supporter",
    policyStances: [
      "Favors ‘Making it more difficult to access pornography on the Internet’",
      "Favors ‘Tougher laws and regulations to protect the environment even if it raises prices or costs jobs’",
      "Thinks ‘Too many people are easily offended these days over the language that others use’"
    ],
    openEndResponse: "I voted for him because I didn’t think Kamala should have been included in the race. She wasn’t in from the beginning; she was thrown in at the last minute when Biden decided to step down. She wasn’t the people’s choice from the start.",
    image: "images/Anna - White Woman 2.webp"
  },
  {
    name: "Sadie",
    demographic: "White female, 25",
    voterType: "Trump supporter",
    policyStances: [
      "Favors ‘Allowing gay and lesbian couples to marry legally’",
      "Favors ‘Tougher laws and regulations to protect the environment even if it raises prices or costs jobs’",
      "Thinks abortion should be ‘Legal in most cases’"
    ],
    openEndResponse: "America needs a change for the better in our economy. I cannot afford to live and I'm tired of financially struggling no matter what we do.",
    image: "images/Sadie - White Woman 3.webp"
  },
  {
    name: "Jessica",
    demographic: "White female, 32",
    voterType: "Harris voter",
    policyStances: [
      "Opposes ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks abortion should be ‘Legal in all cases’",
      "Thinks ‘The government should do more to help needy Americans, even if it means going deeper into debt.’"
    ],
    openEndResponse: "I didn't have incredibly strong feelings about her as a candidate, but for me, the very real and dangerous cons of Donald Trump being president far outweighed any other factor.",
    image: "images/Jessica - White Woman 1.webp"
  },
  {
    name: "Joe",
    demographic: "Hispanic male, 33",
    voterType: "Trump voter",
    policyStances: [
      "Opposes ‘Allowing gay and lesbian couples to marry legally’",
      "Favors ‘Making the use of marijuana legal’",
      "Opposes ‘Deporting all immigrants who are living in the US illegally back to their home country’"
    ],
    openEndResponse: "He's not a politician but a good business man.",
    image: "images/Joe - Hispanic Man 2.webp"
  },
  {
    name: "Antonio",
    demographic: "Hispanic man, 45",
    voterType: "Trump voter",
    policyStances: [
      "Opposes ‘The government offering parents vouchers to send their children to private or religious schools or to a public school of their choice’",
      "Opposes ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks ‘The government should do more to help needy Americans, even if it means going deeper into debt.’"
    ],
    openEndResponse: "I voted for Trump out of support for Israel and the Second Amendment.",
    image: "images/Antonio - Hispanic Man 1.webp"
  },
  {
    name: "Isabella",
    demographic: "Hispanic female, 33",
    voterType: "Trump voter",
    policyStances: [
      "Opposes ‘Allowing gay and lesbian couples to marry legally’",
      "Favors ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks abortion should be ‘Legal in most cases’"
    ],
    openEndResponse: "The most important reason is because of the immigrants coming to America getting all the help and others that have been here before never got nothing.",
    image: "images/Isabella - Hispanic Woman 2.webp"
  },
  {
    name: "Sofía",
    demographic: "Hispanic female, 27",
    voterType: "Didn’t vote",
    policyStances: [
      "Opposes ‘Allowing gay and lesbian couples to marry legally’",
      "Opposes ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks ‘People need to be more careful about the language they use to avoid offending people with different backgrounds’"
    ],
    openEndResponse: "I didn't believe either candidate was right for the job and didn't feel right putting my name behind either one of them.",
    image: "images/Sofia - Hispanic Woman 1.webp"
  },
  {
    name: "Daniel",
    demographic: "Black male, 31",
    voterType: "Trump voter",
    policyStances: [
      "Favors ‘Making it more difficult to access pornography on the Internet’",
      "Favors ‘Deporting all immigrants who are living in the US illegally back to their home country’",
      "Thinks abortion should be ‘Legal in most cases’"
    ],
    openEndResponse: "I would like to say, the economy and immigration were my reasons for voting for Donald Trump.",
    image: "images/Daniel - Black Man 2.webp"
  },
  {
    name: "Michael",
    demographic: "Black male, 24",
    voterType: "Didn’t vote",
    policyStances: [
      "Opposes ‘Allowing gay and lesbian couples to marry legally’",
      "Opposes ‘Tougher laws and regulations to protect the environment even if it raises prices or costs jobs’",
      "Thinks ‘Too many people are easily offended these days over the language that others use’"
    ],
    openEndResponse: "I'm black and it don't matter anyway. They do what they want when it comes to my race in America, we have no voice.",
    image: "images/Michael - Black Man 1.webp"
  },
  {
    name: "Monica",
    demographic: "Black female, 43",
    voterType: "Harris voter",
    policyStances: [
      "Opposes ‘Tougher laws and regulations to protect the environment even if it raises prices or costs jobs’",
      "Thinks abortion should be ‘Legal in most cases’",
      "Thinks ‘The government today can’t afford to do much to help the needy’"
    ],
    openEndResponse: "She as for the working/middle class Americans. She’s not rich and she set out to protect people like me to help us build a better future for our families. She was all about giving everyone a chance to live the American dream. Not deport or fire people trying to make a way.",
    image: "images/Monica - Black Woman 2.webp"
  },
  {
    name: "Samantha",
    demographic: "Black female, 30",
    voterType: "Harris voter",
    policyStances: [
      "Favors ‘The government offering parents vouchers to send their children to private or religious schools or to a public school of their choice’",
      "Thinks abortion should be ‘Legal in most cases’",
      "Thinks ‘Too many people are easily offended these days over the language that others use’"
    ],
    openEndResponse: "I voted for Harris because of her economic policies and plans for supporting working and middle-class Americans.",
    image: "images/Samantha - Black Woman 1.webp"
  },
  {
    name: "James",
    demographic: "AAPI male, 38",
    voterType: "Trump voter",
    policyStances: [
      "Favors ‘Allowing gay and lesbian couples to marry legally’",
      "Opposes ‘The government offering parents vouchers to send their children to private or religious schools or to a public school of their choice’",
      "Thinks abortion should be ‘Illegal in most cases’"
    ],
    openEndResponse: "He is not my favorite person, and I don’t believe he is even a great choice for a presidential candidate, but he was significantly better than Kamala Harris. I could never vote for someone who believes in killing unborn babies.",
    image: "images/James - AAPI Man 1.webp"
  },
  {
    name: "Sarah",
    demographic: "AAPI female, 31",
    voterType: "Didn’t vote",
    policyStances: [
      "Favors ‘Making it more difficult to access pornography on the Internet’",
      "Favors ‘Tougher laws and regulations to protect the environment even if it raises prices or costs jobs’",
      "Thinks abortion should be ‘Legal in all cases’"
    ],
    openEndResponse: "Did not like either of the candidates.",
    image: "images/Sarah - AAPI Woman 1.webp"
  }
];*/

let generatedResultsUrl = null;


for (const profile of youthVoterProfiles) {
  profile.policyStances = profile.policyStances.map((s, i) => `${i + 1}. ${s}`);
}



function createProfileCard(profile, idx) {

  let correctLabel = '';
  if (profile.voterType.toLowerCase().includes('harris')) correctLabel = 'Kamala Harris';
  else if (profile.voterType.toLowerCase().includes('trump')) correctLabel = 'Donald Trump';
  else correctLabel = 'Did not Vote';
  return `
    <div class="border-0 profile-card-outer">
      <div class="d-flex flex-column align-items-center profile-card">
        <img src="${profile.image}" alt="${profile.name}" class="profile-card-img">
        <h2 class="font-weight-bold text-center profile-card-name">${profile.name}</h2>
        <div class="text-center profile-card-demographic">${profile.demographic}</div>
        <button class="btn btn-light d-flex align-items-center justify-content-between show-views-btn profile-show-views-btn" type="button" data-toggle="collapse" data-target="#views-${profile.name.replace(/\s/g, '')}">
          <span>Show personal views</span> <span class="font-weight-bold">+</span>
        </button> 
       <div class="collapse" id="views-${profile.name.replace(/\s/g, '')}">
           <ul class="list-group mb-2 mx-auto profile-views-list">
             <li class="list-group-item profile-views-item">
               <p class="policy-stances-title">a. Policy stances:<p>
               <ol type="i" class="policy-stances-list">
                 ${profile.policyStances.map(s => `<li>${s.replace(/^\d+\.\s/, '')}</li>`).join('')}
               </ol>
             </li>
             <li class="list-group-item profile-views-item">
               <p class="open-ended-response-text"><span class="policy-stances-title">b. Open-ended response:</span>"${profile.openEndResponse}"</p>
             </li>
           </ul>
         </div>
        <div class="mt-5 mb-2 font-weight-bold text-center profile-question">Who do you think ${profile.name} voted for?</div>
        <div class="d-flex justify-content-center profile-question-btns flex-wrap gap-2 mt-3" data-profile-idx="${idx}" data-correct="${correctLabel}">
          <button class="btn vote-btn m-1" data-answer="Kamala Harris">Kamala Harris</button>
          <button class="btn vote-btn m-1" data-answer="Donald Trump">Donald Trump</button>
          <button class="btn vote-btn m-1" data-answer="Did not Vote">Did not Vote</button>
        </div>
      </div>
    </div>
  `;
}
document.getElementById('profiles-root').innerHTML = youthVoterProfiles.map(createProfileCard).join('');

document.querySelectorAll('.show-views-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    const toggleSpan = this.querySelector('.font-weight-bold');
    const targetId = this.getAttribute('data-target');
    const targetElement = document.querySelector(targetId);


    if (targetElement.classList.contains('show')) {
      toggleSpan.textContent = '+';
    } else {
      toggleSpan.textContent = '—';
    }
  });
});


function renderProgressTracker() {
  const tracker = document.getElementById('progress-tracker');
  tracker.innerHTML = '';
  for (let i = 0; i < youthVoterProfiles.length; i++) {
    const box = document.createElement('div');
    box.textContent = i + 1;
    box.className = 'progress-box';
    box.style.width = '48px';
    box.style.height = '48px';
    box.style.display = 'flex';
    box.style.alignItems = 'center';
    box.style.justifyContent = 'center';
    box.style.margin = '0 3px';
    box.style.fontWeight = '500';
    box.style.fontSize = '16px';
    box.style.borderRadius = '12px';
    let bg = '#EFF4F8';
    const answer = userAnswers[i];
    if (answer !== null) {
      const voterType = youthVoterProfiles[i].voterType.toLowerCase();
      const correct = voterType.includes('harris')
        ? 'Kamala Harris'
        : voterType.includes('trump')
        ? 'Donald Trump'
        : 'Did not Vote';
      bg = answer === correct ? '#9CDCB7' : '#EABFAF';
    }
    box.style.background = bg;
    box.style.color = '#000';
    box.style.transition = 'background 0.2s';
    tracker.appendChild(box);
  }
}

const userAnswers = Array(youthVoterProfiles.length).fill(null);
const answered = Array(youthVoterProfiles.length).fill(false);
renderProgressTracker();
function updateSeeResultsBtn() {
  const btn = document.getElementById('see-results-btn');
  if (answered.every(Boolean)) {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  } else {
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';
  }
}
updateSeeResultsBtn();



document.querySelectorAll('[data-profile-idx]').forEach(group => {
  const correct = group.getAttribute('data-correct');
  const idx = parseInt(group.getAttribute('data-profile-idx'));
  const buttons = group.querySelectorAll('.vote-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', function () {
      if (answered[idx]) return;
      this.blur();

      buttons.forEach(b => {
        b.style.background = '#CEDDE9';
        b.style.color = '#000';
      });

      buttons.forEach(b => {
        if (b.getAttribute('data-answer') === correct) {
          b.style.background = '#9CDCB7';
          b.style.borderColor = '#9CDCB7';
          b.style.color = '#000';
        }
      });

      if (this.getAttribute('data-answer') !== correct) {
        this.style.background = '#f73a4c';
        this.style.borderColor = '#f73a4c';
        this.style.color = '#000';
         const currentText = this.textContent.trim();
        if (!currentText.startsWith('×')) {
          this.innerHTML = `<img src="images/Cancels black.svg" width="18" class="cancels"> ${currentText}`;
        }
      }

      answered[idx] = true;
      userAnswers[idx] = this.getAttribute('data-answer');
      renderProgressTracker();
      updateSeeResultsBtn();
    });
  });
});


function renderResultsGrid() {
  const grid = document.querySelector('#results-grid .container-fluid');
  grid.innerHTML = '<div class="row">' + youthVoterProfiles.map((profile, idx) => {
    const userAnswer = userAnswers[idx];
    const correct = (userAnswer === null) ? false : userAnswer === (profile.voterType.toLowerCase().includes('harris') ? 'Kamala Harris' : profile.voterType.toLowerCase().includes('trump') ? 'Donald Trump' : 'Did not Vote');
    let icon = '';
    if (userAnswer) {
      if (correct) {
        icon = `<span class="answer-icon answer-icon--correct"><img src="${quizSettings.themeUrl}/quiz/images/correct.svg"></span>`;
      } else {
        icon = `<span class="answer-icon answer-icon--wrong"><img src="${quizSettings.themeUrl}/quiz/images/wrong.svg"></span>`;
      }
    }
    return `
      <div class="col-lg-3 col-md-6 col-12 mb-4">
        <div class="d-flex align-items-center p-3 results-card">
          <img src="${profile.image}" alt="${profile.name}" class="results-card-img">
          <div class="flex-grow-1">
            <div class="font-weight-bold results-card-name">${profile.name}</div>
            <div class="results-card-demographic">${profile.demographic}</div>
            <div class="d-flex align-items-center mt-2">
              <span class="results-card-answer">${userAnswer ? userAnswer : '<span style=\"color:#bbb;\">No answer</span>'}</span>
              ${icon}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('') + '</div>';
}


document.getElementById('see-results-btn').addEventListener('click', function () {
  const btn = this;
  if (btn.dataset.loading === 'true') return;


  btn.dataset.loading = 'true';
  btn.disabled = true;
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span> Loading results…';

  setTimeout(() => {

    const correctAnswers = userAnswers.filter((answer, idx) => {
      const profile = youthVoterProfiles[idx];
      const correct = profile.voterType.toLowerCase().includes('harris') ? 'Kamala Harris' :
        profile.voterType.toLowerCase().includes('trump') ? 'Donald Trump' : 'Did not Vote';
      return answer === correct;
    }).length;

    const totalAnswered = userAnswers.filter(answer => answer !== null).length;
    document.querySelector('#results-share-section h2').textContent = `${correctAnswers}/${totalAnswered}`;
    document.querySelector('#results-share-section-1 h2').textContent = `${correctAnswers}/${totalAnswered}`;

    const quizData = {
      answers: userAnswers,
      score: correctAnswers,
      result_type: 'default'
    };

    fetch('/wp-json/quiz/v1/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quizData)
    })
      .then(res => res.json())
      .then(data => {
        if (data.key) {
          generatedResultsUrl = `${window.location.origin}/results/${data.key}`;
          // Use this in your share modal
          console.log("Share this:", generatedResultsUrl);
          // Update copy link button if it exists
          const copyBtn = document.querySelector('.copy-link-button');
          if (copyBtn) {
            copyBtn.dataset.link = generatedResultsUrl;
          }
        }
      });


    try {
      const latestScore = {
        correct: correctAnswers,
        total: youthVoterProfiles.length,
        at: Date.now()
      };
      localStorage.setItem('asc_latest_score', JSON.stringify(latestScore));
    } catch (err) {

    }


    document.getElementById('quiz-content').style.display = 'none';
    renderResultsGrid();
    document.getElementById('results-grid').style.display = 'block';
    document.getElementById('results-share-section').style.display = 'block';
    document.getElementById('results-share-section-1').style.display = 'block';
    window.scrollTo(0, 0);


    btn.innerHTML = originalHtml;
    btn.disabled = false;
    btn.dataset.loading = 'false';
  }, 2500);
});

document.getElementById('share').addEventListener('click', function () {
  document.getElementById('share-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
});
document.getElementById('share-1').addEventListener('click', function () {
  document.getElementById('share-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
});


document.getElementById('share-modal').addEventListener('click', function (e) {
  if (e.target === this) {
    this.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
});


(function initCopyLinkHandler() {
  const copyBtn = document.querySelector('.copy-link-button');
  if (!copyBtn) return;
  copyBtn.addEventListener('click', async function () {
    const button = this;
    const resultsUrl = generatedResultsUrl || window.location.href;
    button.disabled = true;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(resultsUrl);
      } else {
        const temp = document.createElement('textarea');
        temp.value = resultsUrl;
        temp.setAttribute('readonly', '');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
      }
      button.textContent = 'Copied link!';
    } catch (err) {

      button.textContent = 'Copied link!';
    } finally {
      button.disabled = false;
    }
  });
})();


(function initSocialShareHandlers() {
  const container = document.querySelector('.social-icons-row');
  if (!container) return;

  function getResultsUrl() {
    return generatedResultsUrl || window.location.href;
  }

  function getShareText() {
    try {
      const raw = localStorage.getItem('asc_latest_score');
      const parsed = raw ? JSON.parse(raw) : null;
      if (parsed && typeof parsed.correct === 'number' && typeof parsed.total === 'number') {
        return `I got ${parsed.correct}/${parsed.total} on this quiz from the Survey Center on American Life. Can you beat my score?`;
      }
    } catch (e) { }
    return 'Can you beat my score on this quiz from the Survey Center on American Life?';
  }

  container.querySelectorAll('.social-icon').forEach(icon => {
    icon.addEventListener('click', async () => {
      const img = icon.querySelector('img');
      const platform = (img && img.alt ? img.alt : '').toLowerCase();
      const url = encodeURIComponent(getResultsUrl());
      const text = encodeURIComponent(getShareText());

      let shareUrl = '';
      if (platform.includes('twitter')) {
        shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
      } else if (platform.includes('facebook')) {
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
      } else if (platform.includes('linked')) {
        shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
      } else if (platform.includes('instagram')) {

        try {
          const plainUrl = decodeURIComponent(url);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(plainUrl);
          } else {
            const temp = document.createElement('textarea');
            temp.value = plainUrl;
            temp.setAttribute('readonly', '');
            temp.style.position = 'absolute';
            temp.style.left = '-9999px';
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
          }
          // alert('Link copied. Paste into Instagram to share.');
        } catch (e) { }
        shareUrl = 'https://www.instagram.com/';
      }

      if (shareUrl) {
        window.open(shareUrl, '_blank', 'noopener,noreferrer');
      }
    });
  });
})();